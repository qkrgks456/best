<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:include="fix/fixHead.html"></th:block>
<body>
<div class="wrapper">
    <th:block th:include="fix/fixSideBar"></th:block>
    <div id="content">
        <!-- 사이드바 토글 버튼 -->
        <nav class="navbar-light my-2">
            <button type="button" id="sidebarCollapse" class="btn btn-danger">
                <i class="navbar-toggler-icon"></i>
            </button>
        </nav>
        <!-- 여기서 부터 내용 넣으세요 -->
        <div class="d-flex justify-content-center">
            <div class="w-75 mt-2">
                <h3 class="px-2" th:text="${map.get('dto').title}"></h3>
                <div class="d-flex justify-content-end">
                    <div class="mx-1" th:text="'작성자 : '+${map.get('dto').id}"></div>
                    <div class="mx-1 border-start border-end border-dark px-2"
                         th:text="'조회수 : '+${map.get('dto').boardHit}"></div>
                    <div class="mx-1">추천수 : 0</div>
                </div>
                <hr/>
                <div class="px-2" th:text="${map.get('dto').content}" style="height: 400px"></div>
                <hr/>
                <th:block th:if="${#lists.size(map.get('photoList')) > 0 }">
                    <div class="d-flex justify-content-center flex-wrap">
                        <th:block th:each="photo : ${map.get('photoList')}">
                            <a th:href="${photo.path}" data-fancybox="responsive">
                                <img class="mx-1 my-1" th:src="${photo.path}" style="width: 200px;height: 200px"/>
                            </a>
                        </th:block>
                    </div>
                    <hr/>
                </th:block>
                <div class="text-center my-2">
                    <a th:href="@{/loveBoard/list/{page}(page=${page})}" class="btn btn-danger rounded-0">리스트로</a>
                    <a class="btn btn-danger rounded-0">추천</a>
                    <a class="btn btn-danger rounded-0"
                       th:if="${map.get('dto').id eq session.loginId}"
                       th:href="@{/loveBoard/boardUpdateForm/{boardNum}/{page}(boardNum=${map.get('dto').boardNum},page=${page})}">수정</a>
                    <a th:if="${map.get('dto').id eq session.loginId}" class="btn btn-danger rounded-0"
                       id="boardDel" th:attr="boardNum=${map.get('dto').boardNum}">삭제</a>
                </div>
                <h3>댓글</h3>
                <hr/>
                <!-- 댓글 입력 폼 -->
                <div class="d-flex align-items-center mt-3">
                    <div class="form-floating flex-grow-1 px-2">
                    <textarea class="form-control rounded-0" placeholder="Leave a comment here"
                              name="commentContent" id="commentContent"
                              style="height: 100px; resize: none;"></textarea>
                        <div class="invalid-feedback">1자 이상 입력해주세요</div>
                        <label th:text="${session.loginId + '님 이곳에 댓글을 작성하세요'}" for="commentContent"></label>
                    </div>
                    <a id="cmInsertBtn" class="btn btn-danger rounded-0 btn-sm">등록</a>
                </div>
                <!-- 댓글 리스트 -->
                <div id="commentLists" class="container px-5 my-4">
                    <th:block th:each="dto : ${map.cmList}">
                        <!-- 댓글 내용 -->
                        <div class="listForm">
                            <div th:text="${dto.id}" class="fw-bold"></div>
                            <div th:text="${dto.content}" class="lh-sm"></div>
                            <div class="d-flex justify-content-end">
                                <div>
                                    <a th:if="${session.loginId ne dto.id && session.loginId != null}"
                                       class="btn btn-danger btn-sm rounded-0"
                                       href="${path}/cm/cmReportForm/${dto.cmNum}">신고</a>
                                    <th:block th:if="${session.loginId eq dto.id}">
                                        <a class='cmUpdateBtnForm btn btn-danger btn-sm rounded-0'>수정</a>
                                        <a th:attr="cmNum=${dto.cmNum}"
                                           class='cmDelBtn btn btn-danger btn-sm rounded-0'>삭제</a>
                                    </th:block>
                                </div>
                            </div>
                            <div th:text="'작성일 :' + ${dto.date}" class="d-flex justify-content-end"></div>
                            <hr/>
                        </div>
                        <!-- 수정하기 폼 -->
                        <div class="updateForm visually-hidden">
                            <div class="form-floating flex-grow-1 px-2">
                            <textarea th:text="${dto.content}" class="cmUpdateContent form-control rounded-0"
                                      style="height: 100px; resize: none;"></textarea>
                                <label>수정할 댓글을 작성하세요</label>
                                <div class="invalid-feedback">1자 이상 입력해주세요</div>
                            </div>
                            <div class="d-flex justify-content-end mt-2">
                                <a th:attr="cmNum=${dto.cmNum}"
                                   class='cmUpdateBtn btn btn-danger btn-sm rounded-0'>등록</a>
                                <a class='cmUpdateCancel btn btn-danger rounded-0 btn-sm ms-1'>취소</a>
                            </div>
                            <hr/>
                        </div>
                    </th:block>
                </div>
                <div id="paginationBox">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:if="${map.get('startPage') ne 1}">
                            <a aria-label="Previous" class="page-link page-info rounded-0"
                               style="cursor:pointer;"
                               th:attr="page=${map.get('startPage') - 1}">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <th:block th:each="num: ${#numbers.sequence(map.get('startPage'),map.get('endPage'))}">
                            <li th:if="${num ne map.get('currPage')}" class="page-item">
                                <a th:text="${num}" class="page-link page-info rounded-0"
                                   style="cursor:pointer;"
                                   th:attr="page=${num}"></a>
                            </li>
                            <li th:if="${num eq map.get('currPage')}" class="page-item active">
                                <a th:text="${num}" class="page-link rounded-0"></a>
                            </li>
                        </th:block>
                        <li class="page-item" th:if="${map.get('totalPage') ne map.get('endPage')}">
                            <a class="page-link page-info rounded-0"
                               style="cursor:pointer;"
                               th:attr="page=${map.get('endPage') + 1}"
                               aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<input th:attr="boardNum=${map.get('dto').boardNum}" type="hidden" id='boardNum'>
</body>
<th:block th:replace="fix/fixFooter.html"></th:block>
<script th:src="@{/js/loading.js}"></script>
<script th:src="@{/js/boardDel.js}"></script>
<script>
    let boardNum = $("#boardNum").attr("boardNum");
    let division = "loveBoard";
    /* 댓글 등록 ajax */
    $('#cmInsertBtn').on('click', function () {
        // 여기에 받을 변수 써주세용
        let cmContent = $('#commentContent').val();
        if (cmContent.trim() != "") {
            $('#commentContent').removeClass('is-invalid');
            $.ajax({
                type: "POST",//방식
                url: "/cm/cmInsert",//주소
                data: {
                    content: cmContent,
                    divisionNum: boardNum,
                    division: division,
                },
                dataType: 'JSON',
                success: function (map) { //성공시
                    commentList(map);
                    $('#commentContent').val("");
                },
                error: function (e) { //실패시
                    console.log(e);
                }
            });
        } else {
            $('#commentContent').addClass('is-invalid');
        }
    })

    /* 댓글 삭제 ajax */
    $(document).on('click', '.cmDelBtn', function () {
        let cmNum = $(this).attr('cmNum');
        $.ajax({
            type: "POST",//방식
            url: "/cm/cmDelete",//주소
            data: {
                cmNum: cmNum,
                divisionNum: boardNum,
            },
            dataType: 'JSON',
            success: function (map) { //성공시
                commentList(map);
            },
            error: function (e) { //실패시
                console.log(e);
            }
        });
    })

    /* 댓글 페이지네이션 클릭시 ajax */
    $(document).on('click', '.page-info', function () {
        let page = $(this).attr('page');
        $.ajax({
            type: "GET",
            url: "/cm/cmList" + "/" + page + "/" + boardNum,
            dataType: 'JSON',
            success: function (map) { //성공시
                commentList(map);
            },
            error: function (e) { //실패시
                console.log(e);
            }
        });
    })

    /* 댓글 업데이트 ajax */
    $(document).on('click', '.cmUpdateBtn', function () {
        let cmNum = $(this).attr('cmNum');
        let cmUpdateContent = $(this).parent().prev().children('.cmUpdateContent').val();
        if (cmUpdateContent.trim() != "") {
            $.ajax({
                type: "POST",//방식
                url: "/cm/cmUpdate",//주소
                data: {
                    divisionNum: boardNum,
                    cmNum: cmNum,
                    cmUpdateContent: cmUpdateContent,
                },
                dataType: 'JSON',
                success: function (map) { //성공시
                    commentList(map);
                },
                error: function (e) { //실패시
                    console.log(e);
                }
            });
        } else {
            $(this).parent().prev().children('.cmUpdateContent').addClass('is-invalid');
        }
    })

    /* 댓글 리스트 메서드 */
    function commentList(map) {
        let content = '';
        /*댓글리스트 불러오기*/
        console.log(map.loginId);
        $.each(map.cmList, function (i, dto) {
            content += '<div class="listForm">'
            content += '<div class="fw-bold">' + dto.id + '</div>'
            content += '<div class="lh-sm">' + dto.content + '</div>'
            content += '<div class="d-flex justify-content-end">'
            content += '<div>'
            if (map.loginId !== dto.id) {
                content += '<a class="btn btn-danger rounded-0 btn-sm" href="">신고</a>'
            } else {
                content += '<a class="cmUpdateBtnForm btn btn-danger rounded-0 btn-sm">수정</a>'
                content += '<a cmNum="' + dto.cmNum + '" class="cmDelBtn btn btn-danger rounded-0 btn-sm ms-1">삭제</a>'
            }
            content += '</div>'
            content += '</div>'
            content += '<div class="d-flex justify-content-end">'
            content += '작성일 :' + dto.date
            content += '</div>'
            content += '<hr/>'
            content += '</div>'
            content += '<div class="updateForm visually-hidden">'
            content += '<div class="form-floating flex-grow-1 px-2">'
            content += '<textarea class="cmUpdateContent form-control rounded-0" style="height: 100px; resize: none;">' + dto.content + '</textarea>'
            content += '<label>수정할 댓글을 작성하세요</label>'
            content += '<div class="invalid-feedback">1자 이상 입력해주세요</div>'
            content += '</div>'
            content += '<div class="d-flex justify-content-end mt-2">'
            content += '<a cmNum="' + dto.cmNum + '" class="cmUpdateBtn btn btn-danger rounded-0 btn-sm">등록</a>'
            content += '<a class="cmUpdateCancel btn btn-danger rounded-0 btn-sm ms-1">취소</a>'
            content += '</div>'
            content += '<hr/>'
            content += '</div>'
        })
        $('#commentLists').empty();
        $('#commentLists').append(content);

        /* 페이지네이션 불러오기 욕나오네 */
        content = '';
        content += '<ul class="pagination justify-content-center">'
        if (map.startPage != 1) {
            content += '<li class="page-item">'
            content += '<a class="page-link page-info rounded-0" page="' + (map.startPage - 1) + '" aria-label="Previous" style="cursor:pointer;">'
            content += '<span aria-hidden="true">&laquo;</span>'
            content += '</a>'
            content += '</li>'
        }
        for (let i = map.startPage; i <= map.endPage; i++) {
            if (map.currPage !== i) {
                content += '<li class="page-item"><a style="cursor:pointer;" class="page-link page-info rounded-0" page="' + i + '" >' + i + '</a></li>'
            } else {
                content += '<li class="page-item active"><a class="page-link rounded-0">' + i + '</a></li>'
            }
        }
        if (map.totalPage !== map.endPage) {
            content += '<li class="page-item">'
            content += '<a class="page-link page-info rounded-0" page="' + (map.endPage + 1) + '" aria-label="Next" style="cursor:pointer;">'
            content += '<span aria-hidden="true">&raquo;</span>'
            content += '</a>'
            content += '</li>'
        }
        content += '</ul>'
        $('#paginationBox').empty();
        $('#paginationBox').append(content);
    }

    // 수정하기 폼 나타내기
    $(document).on('click', '.cmUpdateBtnForm', function () {
        $(this).parents('.listForm').addClass('visually-hidden');
        $(this).parents('.listForm').next().removeClass('visually-hidden');
    })
    $(document).on('click', '.cmUpdateCancel', function () {
        $(this).parents('.updateForm').addClass('visually-hidden');
        $(this).parents('.updateForm').prev().removeClass('visually-hidden');
    })
</script>
</html>